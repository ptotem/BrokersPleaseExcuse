<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAgrj58PbXr2YriiRDqbnL1RSqrCjdkglBijPNIIYrqkVvD1R4QxRl47Yh2D_0C1l5KXQJGrbkSDvXFA" type="text/javascript"></script>
<script type="text/javascript">

    $(function () {

        if (GBrowserIsCompatible()) {
            var map = new GMap2(document.getElementById("map"));
            map.addControl(new GSmallMapControl());
            map.addControl(new GMapTypeControl());
            var center = new GLatLng(19.06726, 72.82644);
            map.setCenter(center, 15);
            geocoder = new GClientGeocoder();
            var marker = new GMarker(center, {draggable:true});
            map.addOverlay(marker);
            document.getElementById("building_address_latitude").innerHTML = center.lat().toFixed(5);
            document.getElementById("building_address_longitude").innerHTML = center.lng().toFixed(5);

            GEvent.addListener(marker, "dragend", function () {
                var point = marker.getPoint();
                map.panTo(point);
                document.getElementById("building_address_latitude").innerHTML = point.lat().toFixed(5);
                document.getElementById("building_address_longitude").innerHTML = point.lng().toFixed(5);

            });


            GEvent.addListener(map, "moveend", function () {
                map.clearOverlays();
                var center = map.getCenter();
                var marker = new GMarker(center, {draggable:true});
                map.addOverlay(marker);
                document.getElementById("building_address_latitude").innerHTML = center.lat().toFixed(5);
                document.getElementById("building_address_longitude").innerHTML = center.lng().toFixed(5);


                GEvent.addListener(marker, "dragend", function () {
                    var point = marker.getPoint();
                    map.panTo(point);
                    document.getElementById("building_address_latitude").innerHTML = point.lat().toFixed(5);
                    document.getElementById("building_address_longitude").innerHTML = point.lng().toFixed(5);

                });

            });

        }


        $('#update-map').click(function () {
            showAddress($('#search').value);
            return false;
        })


    });

    function showAddress(address) {
        var map = new GMap2(document.getElementById("map"));
        map.addControl(new GSmallMapControl());
        map.addControl(new GMapTypeControl());
        if (geocoder) {
            geocoder.getLatLng(
                    address,
                    function (point) {
                        if (!point) {
                            alert(address + " not found");
                        } else {
                            document.getElementById("building_address_latitude").innerHTML = point.lat().toFixed(5);
                            document.getElementById("building_address_longitude").innerHTML = point.lng().toFixed(5);
                            map.clearOverlays()
                            map.setCenter(point, 14);
                            var marker = new GMarker(point, {draggable:true});
                            map.addOverlay(marker);

                            GEvent.addListener(marker, "dragend", function () {
                                var pt = marker.getPoint();
                                map.panTo(pt);
                                document.getElementById("building_address_latitude").innerHTML = pt.lat().toFixed(5);
                                document.getElementById("building_address_longitude").innerHTML = pt.lng().toFixed(5);
                            });


                            GEvent.addListener(map, "moveend", function () {
                                map.clearOverlays();
                                var center = map.getCenter();
                                var marker = new GMarker(center, {draggable:true});
                                map.addOverlay(marker);
                                document.getElementById("building_address_latitude").innerHTML = center.lat().toFixed(5);
                                document.getElementById("building_address_longitude").innerHTML = center.lng().toFixed(5);

                                GEvent.addListener(marker, "dragend", function () {
                                    var pt = marker.getPoint();
                                    map.panTo(pt);
                                    document.getElementById("building_address_latitude").innerHTML = pt.lat().toFixed(5);
                                    document.getElementById("building_address_longitude").innerHTML = pt.lng().toFixed(5);
                                });

                            });

                        }
                    }
            );
        }
    }
</script>


<%= b.fields_for :address do |loc| %>

    <h2>Location</h2>

    <div class="row-fluid">
      <div class="span3">
        <%= loc.label :road %>
      </div>
      <div class="span4">
        <%= loc.text_field :road, :class => "span3" %>
      </div>
    </div>

    <div class="row-fluid">
      <div class="span3">
        <%= b.label "Also considered to be in" %>
      </div>
      <div class="span4">
        <%= fields_for 'building_localities[]' do |location| %>
            <%= location.select :locality_id, options_from_collection_for_select(@localities, 'id', 'name', @building.building_localities.map { |l| l.id }), {}, {:multiple => true, :class => 'chzn-container-multi span3'} %>
        <% end %>
      </div>
    </div>


    <div class="row-fluid">
      <div class="span3">
        <%= loc.label :pincode %>
      </div>
      <div class="span4">
        <%= loc.number_field :pincode, :class => "span3" %>
      </div>
    </div>
    <hr>
    <div class="row-fluid">
      <div class="span2">
        <%= loc.label :latitude %>
        <%= loc.number_field :latitude, :class => "span3" %>
      </div>
      <div class="span2">
        <%= loc.label :longitude %>
        <%= loc.number_field :longitude, :class => "span3" %>
      </div>
      <div class="span2">
        <%= link_to "Search", "#", :id => "update-map" %>
        <br>
        <%= text_field_tag :search, "", :id => "search" %>
      </div>
    </div>
    <br>
    <div id="map" style="width: 600px; height: 400px"><br/></div>


    <h2>Directions</h2>
    <%= b.fields_for :building_routes do |builder| %>
        <%= builder.text_area :name, :rows => 3, :class => "span3" %>
        <%= builder.link_to_remove "Remove" %> <br/>
    <% end %>
    <%= b.link_to_add 'Add Route', :building_routes %> <br/>

<% end %>
