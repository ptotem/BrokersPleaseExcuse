<%= nested_form_for(@building) do |b| %>
    <%= b.fields_for :flats, @flat do |f| %>

        <%= hidden_field_tag :came_from, "building_features" %>
        <%= hidden_field_tag :flat_id, @flat.id %>

        <%= render :partial => 'form_menu' %>
        <br>
        <div class="content detail-panel" id="basic-panel">

          <h2>Building Quality</h2>

          <div class="row-fluid">
            <div class="span3">
              Building Quality:
            </div>
            <div class="span4">
              <%= b.select :building_quality_id, options_from_collection_for_select(@qualities, :id, :name, @building.building_quality_id), {}, {:class => "chzn-select span3", :'data-placeholder' => "Select Quality"} %>
            </div>
          </div>
          <div class="row-fluid">
            <div class="span3">
              Approach Quality:
            </div>
            <div class="span4">
              <%= b.select :approach_quality_id, options_from_collection_for_select(@qualities, :id, :name, @building.approach_quality_id), {}, {:class => "chzn-select span3", :'data-placeholder' => "Select Quality"} %>
            </div>
          </div>


          <h2>Building Facilities</h2>

          <div class="row">
            <div class="span9">
              <% @facilities.each do |facility| -%>
                  <div>
                    <%= hidden_field_tag 'building[facility_ids][]', nil %>
                    <%= check_box_tag :facility_ids, facility.id, @building.facilities.include?(facility), :name => 'building[facility_ids][]', :onchange => "$(this).next().next().toggle();" %>
                    <%= label_tag :facility_ids, facility.name -%>

                    <% if @building.facility_ids.include?(facility.id) %>
                        <div class="blocky">
                          <% facility.facility_features.each do |facility_feature| %>
                              <%= hidden_field_tag 'building[facility_feature_ids][]', nil %>
                              <%= check_box_tag :facility_feature_ids, facility_feature.id, @building.facility_features.include?(facility_feature), :name => 'building[facility_feature_ids][]' %>
                              <%= label_tag :facility_feature_ids, facility_feature.name -%>
                          <% end %>
                        </div>
                        <br/>
                    <% else %>
                        <div style="display:none;" class="blocky">
                          <% facility.facility_features.each do |facility_feature| %>
                              <%= hidden_field_tag 'building[facility_feature_ids][]', nil %>
                              <%= check_box_tag :facility_feature_ids, facility_feature.id, @building.facility_features.include?(facility_feature), :name => 'building[facility_feature_ids][]' %>
                              <%= label_tag :facility_feature_ids, facility_feature.name -%>
                          <% end %>
                        </div>
                        <br/>
                    <% end %>


                  </div>
              <% end -%>
            </div>
          </div>
          <br>

          <h2>Building Notes</h2>

          <%= b.fields_for :building_notes do |builder| %>
              <%= builder.text_area :name, :rows => 2, :class => "span11" %>
              <%= builder.link_to_remove "Remove" %>
          <% end %>

          <%= b.link_to_add 'Add Note', :building_notes %> <br/>

          <%= b.submit "Save and Continue", :class => "submitter btn btn-primary btn-large", :id => "submit-basic" %>
        </div>


    <% end %>
<% end %>


