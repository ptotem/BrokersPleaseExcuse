<%= content_for :head do %>
    <%= javascript_include_tag "exclusions/dhtmlxcommon" %>
    <%= javascript_include_tag "exclusions/dhtmlxgrid" %>
    <%= javascript_include_tag "exclusions/dhtmlxgrid_filter" %>
    <%= javascript_include_tag "exclusions/dhtmlxgrid_srnd" %>
    <%= javascript_include_tag "exclusions/dhtmlxgrid_start" %>
    <%= javascript_include_tag "exclusions/dhtmlxgridcell" %>

    <script type="text/javascript">
        function clickmodal_link(data, element, task_id) {

            $("#new_interaction_form").children(".modal-body").html("");

            $.get("/interactions/new?task_id=" + task_id + "&prev_comment=" + data, function (data) {
                $($(element).attr("href")).children(".modal-body").html(data);
            });

        }

        var mygrid;
        function doInitGrid() {
            mygrid = new dhtmlXGridFromTable("dhtmlx_interactions_table");

            mygrid.setSkin("bpe");
            mygrid.attachHeader("#text_filter,#select_filter,#text_filter,#text_filter");
            mygrid.enableAutoWidth(true);
            mygrid.enableAutoHeight(false);
            mygrid.setSizes();


            mygrid.setColWidth(0, 60);
            mygrid.setColWidth(1, 60);
            mygrid.setColWidth(2, 300);
            mygrid.setColWidth(3, 150);

            //hiding columns
            //  mygrid.setColumnHidden(0,true);
        }

        $(function () {
            doInitGrid();

            $('.summary-task').click(function () {
                $(this).parent().find('.detailed-task').slideDown();
                $(this).hide();
            });
            $('.detailed-task a.collapser').click(function () {
                $(this).parent().parent().parent().find('.detailed-task').hide();
                $(this).parent().parent().parent().find('.summary-task').show();
            });

            $(".interaction_link").click(function () {

                //alert("index");
                $('#modal_' + $(this).attr("id") + "_index").modal('show');
            });

            $('select.filtration').change(function () {
                var status = $('#status').val();
                var role = $('#role').val();
                var player = $('#players').val();
                if (status == "all") {
                    status = "due overdue";
                }
                if (role == "all") {
                    role = "assigned involved others";
                }
                $('.task-item').hide();
                for (i = 0; i < status.split(' ').length; i++) {
                    for (j = 0; j < role.split(' ').length; j++) {
                        var classstring = "." + status.split(' ')[i] + "." + role.split(' ')[j];
                        $('.task-item' + classstring).show();
                        $('.task-item').each(function () {
                            if ($(this).children(':first').text().match(player.toString()) == null && player.toString() != "All") {
                                $(this).hide();
                            }
                        });
                    }
                }

                return false;
            });
        });

    </script>

    <style type="text/css">

    </style>

<% end %>
<div class="span5 info-unit page-sized" style="margin-left: -20px">
  <% if @contact_page %>
      <h2>Properties Linked</h2>

      <div class="orangey" style="height: 85px;overflow: auto;">

        <% @contact.flat_contacts.each do |flat_contact| %>
            <% unless flat_contact.labelling.blank? %>
                <%= flat_contact.labelling.name %>
                : <%= link_to flat_contact.flat.flat_key, show_property_path(flat_contact.flat), :class => "property_link" %>
                ( <span style="font-size: 10px;"><%= flat_contact.flat.name %>, <%= flat_contact.flat.building.name %>
        , <%= flat_contact.flat.building.main_locality.name %>) --<%= flat_contact.name %></span>
                <br>
            <% end %>
        <% end %>
      </div>

      <br>
  <% end %>
  <h2>
    Tasks
    <div class="pull-right">
      <%= hidden_field_tag :task_job, "new" %>
      <%= select_tag :status, options_for_select([["All", "all"], ["Due", "due"], ["Overdue", "overdue"]]), {:style => "width:80px", :class => 'filtration'} %>
      <%= select_tag :role, options_for_select([["All", "all"], ["Assigned", "assigned"], ["Involved", "involved"]]), {:style => "width:80px", :class => 'filtration'} %>
      <%= select_tag :players, options_from_collection_for_select(Contact.all, 'name', 'name'), {:class => "span3 chosen-select filtration"} %>
    </div>
  </h2>
  <br>
  <br>
  <!---->

  <!-- Tasks Panel -->
<%#= TODO Please include jScrollPane for the scrolling here %>
<%#= TODO Build the filters using the Select tags above %>
  <div id="task-panel" style="height: 320px;overflow: auto;">
    <% @tasks.each_with_index do |task, index| %>
        <% if task.active %>
            <div id="task_<%= task.id %>" class="task-item <%= (Time.now>task.due_date) ? "overdue" :"due" %> <%= if (task.assigned_to==current_user.contact.id) then
                                                                                                                    "assigned"
                                                                                                                  elsif (!InteractionContact.find_by_interaction_id_and_contact_id(task.interaction.id, current_user.contact.id).blank?) then
                                                                                                                    "involved"
                                                                                                                  else
                                                                                                                    "others"
                                                                                                                  end %>">
              <div class="row-fluid" style="margin-bottom: 5px;">
                <div>
                  <div class="summary-task <%= (Time.now>task.due_date) ? "overdue_summary" :"blocky" %>">
                    <% @primary_contact = Contact.find(task.interaction.primary_contact_id) %>
                    <%= @primary_contact.name %> |
                    <%= @primary_contact.phones.first.name unless @primary_contact.phones.count.zero? %>  |
                    <%= @primary_contact.emails.first.name unless @primary_contact.emails.count.zero? %>
                    <div class="pull-right" style="text-align: right;">
                      Due: <%= task.due_date.strftime("%e %b") %>
                      <br>
                      <span style="font-size: 10px;font-weight: normal;">Last Contact:<%= task.interaction.interaction_date.strftime("%e %b") %></span>
                    </div>
                    <br>
                    <br>

                    <div style="font-weight: normal"><%= "#{raw task.interaction.name[0..60]} ...." %></div>
                  </div>
                  <div class="detailed-task" style="display: none;">
                    <div class="row-fluid">
                      <div class="span9">
                        <%= raw task.interaction.name %>
                        <br/>
                        <br/>
                      </div>
                      <div class="span3" style="text-align: right;">
                        <h2><%= task.due_date.strftime("%e %b") %></h2>

                        <span style="font-size: 10px;font-weight: normal;">Last contact:<%= task.interaction.interaction_date.strftime("%e %b") %></span>
                      </div>
                    </div>
                    <div class="row-fluid ">
                      <div class="span12 <%= (Time.now>task.due_date) ? "overdue-detailed" :"due-detailed" %>" style="margin-left: -4px;padding-left: 5px;">

                        <span style="font-weight: bold">To: <%= Contact.find(task.assigned_to).name.humanize %>
                          | </span>
                        For:
                        <a target="_blank" href="<%= contact_path(@primary_contact) %>" id="cnt_<%= @primary_contact.id %>_<%= task.id %>"> <%= @primary_contact.display_name %>
                          |</a>
                        <br>
                        Involved:
                        <% task.interaction.contacts.each do |contact| %>
                            <%#this is to handle exception in relationships
                                in case of any exceptions raised due to this relationship,
                                the default value of @col is set at #ff00ff in the rescue block.

                            %>
                            <% begin %>
                                <% case contact.contact_types.first.name %>
                        <% when "Vendor" %>
                                    <% @col="#ff0000" %>
                                <% when "Client" %>
                                    <% @col="#0088CC" %>
                                <% when "Employee" %>
                                    <% @col="#338833" %>
                                <% when "Partner" %>
                                    <% @col="#ff00ff" %>
                                <% else %>
                                    <% @col="#ff00ff" %>
                                <% end %>
                            <% rescue Exception => e %>
                                <% @col = "#000000" %>

                            <% end %>

                            <style type="text/css">
                                #cnt_<%= contact.id %>_ <%= task.id %> {
                                    color: <%= @col %>;
                                }
                            </style>

                            <a target="_blank" href="<%= contact_path(contact) %>" id="cnt_<%= contact.id %>_<%= task.id %>"><%= contact.name %> </a>
                            |
                        <% end %>
                        <br>

                        <span style="font-size: 10px;font-weight: normal;">Created By: <%= Contact.find(task.interaction.created_by).name %></span>
                      </div>
                      <a data-toggle="modal" href="#task_modal<%= index %>" onclick="clickmodal_link('COMPLETE',this,<%= task.id %>);" class="modal-link">Mark
                        as
                        Complete</a> |
                      <a data-toggle="modal" href="#task_modal<%= index %>" onclick="clickmodal_link('RESCHEDULE',this,<%= task.id %>); " class="modal-link">Re-Schedule</a>
                      |
                      <a data-toggle="modal" href="#task_modal<%= index %>" onclick="clickmodal_link('CANCEL',this,<%= task.id %>);" class="modal-link">Cancel</a>

                      <a class="collapser pull-right" href="#">Collapse</a>
                    </div>
                  </div>
                </div>
              </div>


              <div class="modal hide fade" id="task_modal<%= index %>" style="width:840px;height:500px;">
                <div class="modal-header">
                  <button class="close" data-dismiss="modal">×</button>
                  <h3>Amend Task</h3>
                </div>
                <div class="modal-body">
                  <%#= render 'interactions/form', :locals => {:task => task, :prev_comment => "Cancelled"} %>
                </div>
                <div class="modal-footer">
                  <a href="#" class="btn">Close</a>
                </div>
              </div>
            </div>

        <% end %>
    <% end %>
  </div>
  <!---->

</div>
<div class="span7" style="margin-left: 10px;">
  <div class="info-unit page-sized">
    <% if @contact_page %>
        <h2>Background
          <%= link_to "Network Map", "#", :class => "btn btn-info pull-right" %>
        </h2>
        <%= f.text_area :qknote, :value => @contact.qknote, :style => "width:75%;height:90px;padding:5px;font-size:10px;font-weight:normal" %>
        <%= f.submit "Update", :style => "width:20%; height:100px;", :class => "btn btn-inverse" %>
    <% end %>
    <!--Header and Search for Interactions-->
    <h2>
      Interactions
    </h2>

    <div class="pull-right123">
      <!-- TODO Build an interaction table using DHTMLX (Fields: Date, InteractionType, Interaction summary, (Hidden but searchable: Added by, InteractionContacts, InteractionFlats -> Opens in a modal)  -->
      <table style="font-size: 12px" id="dhtmlx_interactions_table" gridHeight="400px">
        <tr>
          <td>Date</td>
          <td>Type</td>
          <td>Summary</td>
          <td>Primary Contact</td>

        </tr>

        <% @interactions.each do |interaction| %>
            <tr>
              <td><%= interaction.interaction_date.strftime("%e %b") %></td>
              <td><%= InteractionType.find(interaction.interaction_type_id).name %></td>
              <td><a href="#" id="<%= interaction.id %>" class="interaction_link"><%= interaction.name[0, 80] %></a>
              </td>
              <td><%= link_to Contact.find(interaction.primary_contact_id).display_name, contact_path(Contact.find(interaction.primary_contact_id)), :target => "_blank" %></td>

            </tr>

            <div class="modal fade " id="modal_<%= interaction.id %>_index">
              <div class="modal-header">
                <button class="close" data-dismiss="modal">×</button>
                <h3><%= Contact.find(interaction.primary_contact_id).name %>
                  |<%= interaction.interaction_date.strftime("%e %b") %>
                  |<%= InteractionType.find(interaction.interaction_type_id).name %></h3>
              </div>
              <div class="modal-body">
                <p>

                  <u>Interaction Details:</u>
                  <%= interaction.name %>
                </p>

                <br>
                <br>

                <p>
                  <u>Primary Contact:</u>
                  <%= Contact.find(interaction.primary_contact_id).display_name %>
                </p>

                <p>
                  <u>Others Involved:</u>
                  <%= interaction.contacts.map { |contact| contact.name }.join("|") %>
                </p>
                <br>

                <p>
                  <u>Properties Involved:</u>

                  <%= interaction.flats.map { |flat| flat.name+"--"+flat.building.name+"--"+flat.building.main_locality.name }.join("|") %>
                </p>
                <br>
                <% if interaction.taskings.count>0 %>
                    <p>
                      <u>Next Interaction Due :</u>
                      <%= interaction.taskings.first.due_date.strftime("%e %b") %>
                    </p>
                    <br>

                    <p>
                      <u>Assigned To :</u>
                      <%= Contact.find(interaction.taskings.first.assigned_to).name %>
                    </p>
                    <br>
                <% end %>
                <p>
                  <u>Created By :</u>
                  <%= Contact.find(interaction.created_by).name %>
                </p>
                <br>

              </div>
              <div class="modal-footer">
                <a href="#" class="btn btn-danger" data-dismiss="modal">Close</a>

              </div>
            </div>
        <% end %>
      </table>

    </div>
    <br>
    <br>

  </div>
</div>

